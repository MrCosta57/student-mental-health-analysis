---
title: "Mind Matters: A Data-driven Examination of College Students' Mental Health"
subtitle: "Statistical Inferecence and Learining project"
author: "Giovanni Costa - 880892"
date: "AY 2023/24"
geometry: "left=1cm,right=2cm,top=1cm,bottom=1cm"
output:
  html_document:
    toc: true
    number_sections: true
    toc_depth: 2
    toc_float:
      smooth_scroll: false
    fig_caption: yes
    theme: flatly
    highlight: pygments
    css: "assets/css/styles.css"
editor_options:
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Introduction
This project aims to delve into the pressing issue of mental health among college students, a topic of significant importance in today's fast-paced, high-stress academic environment. By utilizing a data-driven approach, the analysis seeks to provide a comprehensive understanding of the mental health landscape in universities, with a particular focus on psychiatric symptoms and other associated health problems.

One of the key purposes of this project is to predict whether certain individuals may be at a higher risk of suicidal ideation. This predictive analysis could potentially serve as an early warning system, enabling universities to provide timely intervention and support to those in need.

Furthermore, this project aims to provide actionable insights that can guide the development of more effective mental health policies and support systems within universities. By understanding the specific challenges faced by students, universities can tailor their resources and initiatives to better address these issues, ultimately fostering a healthier, more supportive academic environment.

The dataset, that can be retrieved <a href="https://psycharchives.org/en/item/5d25cf8a-7910-4579-9e39-688c6bbec43a">here</a> contains 27014 objects with 16 features. The first six are categorical information about the general individual condition, instead the others are numeric variables related to the mental health of the students, where the higher score indicates more serious symptoms. Additional details regarding the data scales, where the data comes from and the methodology for retrieving them are not provided by the dataset website.<br/>
A specific description of these features is provided below:

1. **gender**: 0=Female, 1=Male
2. **whether_only_child**: 0=No, 1=Yes
3. **birth_place**: 0=Countryside, 1=Town, 2=SmallCity, 3=MediumToLargeCities
4. **family_economic_status**: 0=ExtremelyPoor, 1=Poor, 2=Average, 3=Good, 4=Rich
5. **major**: 0=Liberal, 1=Science, 2=Art
6. **grade**: 0=Postgraduate, 1=UndergraduateGradeFive, 2=Junior, 3=Sophomore, 4=Freshman, 5=Senior
7. **psychiatric_symptoms**: range from 4 to 16
8. **suicide**: range from 4 to 16
9. **dependence**: range from 4 to 16
10. **impulsivity**: range from 4 to 16
11. **compulsion**: range from 4 to 16
12. **sleeping_disturbance**: range from 4 to 16
13. **internet_addiction**: range from 5 to 20
14. **hostile_aggression**: range from 4 to 16
15. **self_injury_behaviors:** range from 4 to 16
16. **eating_problems**: range from 4 to 16

The purposes of this analysis are inspecting the possible hidden patterns present in the data and predicting the risk of observing a suicide, modeled for convenience as a binary variable. 

# Prerequirements
```{r results='hide', message=FALSE, warning=FALSE}
set.seed(123) # set pseudorandom generator for reprocucibility

# Load all the packages and install them if they are not present
requirements <- c("summarytools", "MASS", "effects", "pROC", "mgcv", 
                  "glmnetUtils", "e1071", "class",
                  "stringr", "ggplot2", "reshape2", "scales",  "comprehenr", 
                  "randomForest", "dplyr", "ggcorrplot")

for (library_name in requirements){
  if (!require(library_name, character.only = TRUE)) {
    install.packages(library_name, repos = "https://cloud.r-project.org")
    library(library_name, character.only = TRUE)
  }
}
# Import user defined functions
source("utils.R")
# library(styler)
# style_file("analysis_report.Rmd")
```


# First overview and data engineering

In this section, exploratory data analysis (EDA) is performed to understand the structure of the dataset and identify any potential issues that need to be addressed. Also, data engineering is applied to transform the variables into the appropriate format.
```{r}
# Read the dataset
df <- read.csv("data/mental_health_data.csv")
# Remove the column representing the row index
df <- df[, -1]

# Rename existing columns
colnames(df)[colnames(df) == "whether.only.child"] <- "whether_only_child"
colnames(df)[colnames(df) == "birth.place"] <- "birth_place"
colnames(df)[colnames(df) == "family.economic.status"] <- "family_economic_status"
colnames(df)[colnames(df) == "psychiatric.symptoms"] <- "psychiatric_symptoms"
colnames(df)[colnames(df) == "sleeping.disturbance"] <- "sleeping_disturbance"
colnames(df)[colnames(df) == "internet.addiction"] <- "internet_addiction"
colnames(df)[colnames(df) == "hostile.aggression"] <- "hostile_aggression"
colnames(df)[colnames(df) == "self.injury.behaviors"] <- "self_injury_behaviors"
colnames(df)[colnames(df) == "eating.problems"] <- "eating_problems"


# Transforming variables into factors
df$gender <- factor(df$gender,
  levels = c(0, 1),
  labels = c("Female", "Male")
)
df$whether_only_child <- factor(df$whether_only_child,
  levels = c(0, 1),
  labels = c("No", "Yes")
)
df$birth_place <- factor(
  df$birth_place,
  levels = 0:3,
  labels = c("Countryside", "Town", "SmallCity", "MediumToLargeCities")
)
df$family_economic_status <- factor(
  df$family_economic_status,
  levels = 0:4,
  labels = c("ExtremelyPoor", "Poor", "Average", "Good", "Rich")
)
df$major <- factor(df$major,
  levels = 0:2,
  labels = c("Liberal", "Science", "Art")
)
df$grade <- factor(
  df$grade,
  levels = 0:5,
  labels = c(
    "Postgraduate",
    "UndergraduateGradeFive",
    "Junior",
    "Sophomore",
    "Freshman",
    "Senior"
  )
)

general_cols <- c("gender", "whether_only_child", "birth_place", "family_economic_status", "major", "grade")
symptoms_cols <- c("psychiatric_symptoms", "dependence", "impulsivity", "compulsion", "sleeping_disturbance", "internet_addiction", "hostile_aggression", "self_injury_behaviors", "eating_problems")
```

```{r}
print_summary_custom(df)
```

```{r}
# "Dataset dimensions:"
dim(df)
# "N. of missing values:"
sum(is.na(df))
# "N. of duplicated rows:"
sum(duplicated(df))
# "Example of some objects:"
head(df, 3)
```

From the above table it can be seen that all the column have the right format now. Also can be observed that there are no missing values but some duplicate rows are present. Duplicates in this case probably refers to students that have the same profile conditions and that have replayed in the same way to the survey for building the dataset. It's choosen to keep these rows to mantain the original dataset semantics.

Talking about the summary of the dataset different aspects can be observed:

- The majority of the students are female (67.5\%)
- A lot of person have at least one brother or sisters (72.8\%)
- Less students in the dataset are from Medium to Large Cities (10.2\%)
- The number of students with average family economic status is the highest (66.8\%), instead the number of students with rich family it quite low (0.4\%)
- The most common major is Liberal (58.5\%)
- Only 0.3\% of the person are undergraduate with grade five, instead the other grades are quite equally distributed
- The mean value of the variable Internet addiction is near 10 (scale [5, 20]) while the means for sleeping disturbance, impulsivity, compulsion, dependence are around 7 (scale [4, 16]). These symptoms scores are a bit higher with respect to the other variables values
- No peoples with self-injury behaviors has symptoms of value 15 and they have the lowest average score (4.82), suggesting it might be the least prevalent issue
- In general students with very high symptoms are fortunately the minority among the observed data sample, so the numeric distribution is right skewed.


For convenience, in this analysis it's decided to transform the variable *suicide* in a binary feature, considering the current problem as a classification task.<br/>
In this sense, the values of *suicide* lower or equal to 8 take the value FALSE, instead the other take the value TRUE. The choice of this threshold is considered reasonable because the purpose of this analysis is to consider higher severity of suicide but at the same time don't underestimate the risk even if the value of severity is not too high.


```{r}
print(summary(df$suicide))

numeric_suicide <- df$suicide
scaled_suicide <- numeric_suicide - min(numeric_suicide)
factor_suicide <- as.factor(df$suicide>8)
df$suicide <- factor_suicide

print(summary(df$suicide))
```


# Exploratory Data Analysis
After a first overview of the data it's needed to inspect some possible relations and hidden pattern between the variables. Some guessed interaction terms are also checked.

## Frequencies with respect to response variable

### General information columns
```{r fig.width=8, fig.height=4, message=FALSE, warning=FALSE}
for (col in general_cols){
  plot_freq_by_category(df, col, "suicide")
}
```

Looking at the bar plots referring to the general information about the students, it seems that there are no strange relationship between the categories and the values of the frequencies for the variable *suicide*: in particular the higher number of suicide for a categorical level is usually related with the higher number of person in that level.
Just for the grade *Freshmen* the number of suicide is higher than the other levels, and in particular there are less suicide for lower grading. Grade variable it's possibly related to some age information that in the dataframe is not present and it could suggest that yunger person are less prone to suicide. 


```{r fig.width=8, fig.height=4, message=FALSE, warning=FALSE}
for (col in general_cols){
  plot_proportion_by_category(df, col, "suicide")
}
```

The plots above regarding the proportions of students for each category divided by suidice response values instead highlight interesting patterns: indeed it's more clear to understand the relationships by these plots that consider the ratios and not the frequencies because the y scale is large.

There are few visible things by this visualization:

- The relative difference in suicide frequency considering the *gender* seems not so significant based on these data, instead the gap is more noticeable compared with *whether only child*
- It seems that the percentage of suicide in *Medium to Large cities* is higher.
- Being in a rich family lead to higher proportion of suicide based on this dataset
- Attempting the Liberal or the Art major have similar suicide ratio and this is higher with respect to science courses
- As observed before the percentage of positive values in the response variable is higher for freshman category 


### Symptoms information columns
```{r fig.width=8, fig.height=4, message=FALSE, warning=FALSE}
for (col in symptoms_cols){
  plot_freq_by_category(df, col, "suicide")
}
```

The histograms of the symptoms features show a slightly different behavior compared with the other categorical predictors. As observed in the beginning the number of high serverity symptoms in general is low but the frequency of suicide get bigger when these symptoms increase (compulsion, internet addition, sleeping disturbance)


```{r fig.width=8, fig.height=4, message=FALSE, warning=FALSE}
for (col in symptoms_cols){
  plot_proportion_by_category(df, col, "suicide")
}
```


Checking the proportion histograms divided by the response variable what stated in the previously becomes more evident: now it can be seen noticeable increasing trend in the suicide ratios when the symtoms severity increases and in particular the percentage are higher for the variables psyciatric symptoms, hostile aggression, self-injury behaviours and eating problems, even if the frequency of the higher symtoms for them is quite low (except for compulsion)


## Numeric variables
```{r}
corr_matrix <- round(cor(df[, symptoms_cols]), 2)
ggcorrplot(corr_matrix, 
           hc.order = TRUE, 
           type = "lower", 
           lab = TRUE, 
           lab_size = 3,
           colors = c("#6D9EC1", "white", "#E46726"), 
           title="Pearson correlation", 
           ggtheme=theme_minimal()+ 
             theme(plot.title = element_text(hjust = 0.5)))
```

The heatmap of the correlation matrix shows that all the variables are quite highly positive correlated with each other. By the plot can be seen that the most correlated variables are *impulsivity* and *compulsion* (0.72), *dependence* and *impulsivity* (0.71), *dependence* and *compulsion* (0.68). Also *self-injury behaviours* and *eating problems* seems to be correlated in a significant way (0.66).

Correlation coefficient significance test is performed to check if for these features correlation is statistically significant. The formula for the t-statistic is: 
$t_c=\frac{r}{\sqrt{\frac{1-r^2}{n-2}}}= \frac{r \sqrt{n-2}}{\sqrt{1-r^2}}$
```{r}
cor.test(df$impulsivity, df$compulsion)
cor.test(df$dependence, df$impulsivity)
cor.test(df$dependence, df$compulsion)
cor.test(df$self_injury_behaviors, df$eating_problems)
cor.test(df$self_injury_behaviors, df$internet_addiction)
```

The p-values for the correlation tests are all very close to zero, indicating that the correlations are statistically significant.
However, this information it's not fully considered because numeric variables have all positive variables and they are almost all in the same scale.


## Interaction terms
Just for better understanding the possible interaction between the variables, some scatter plots are drawn to check if there are some evident patterns that can be useful for the model development. For this purpose, the response variable is considered again as a numeric variable and a line is fitted for highlight the linear relation between variables divided by categories.

In particular the following interactions are considered:

- **Psychiatric symptoms and gender**: It's important  to inspect these variables because psychiatric conditions often manifest differently across genders, potentially leading to gender-specific patterns in symptoms and treatment outcomes.

- **Eating problems and family economic status**: Economic factors can affect access to resources and support for managing eating problems, influencing the severity and consequences of these issues in different socioeconomic groups.

- **Sleeping disturbance and major**: Different majors may have varying stress levels and workload demands, which can interact with sleep disturbances to affect academic performance and mental health uniquely in each field of study.

- **Hostile aggression and birth place**: Cultural norms around aggression and conflict resolution can vary significantly by location, impacting how hostile aggression influences social relationships and legal issues in different birthplaces.
```{r}
df$suicide <- numeric_suicide
```

```{r message=FALSE, warning=FALSE}
ggplot(df, aes(x = psychiatric_symptoms, y = suicide, color = gender)) +
  geom_point() +
  geom_smooth(method="lm", se = FALSE, aes(group = gender)) +
  labs(title = "Suicide vs psychiatric symptoms by gender interaction",
       x = "Psychiatric symptoms",
       y = "Suicide")
```

```{r message=FALSE, warning=FALSE}
ggplot(df, aes(x = eating_problems, y = suicide, color = family_economic_status)) +
  geom_point() +
  geom_smooth(method="lm", se = FALSE, aes(group = family_economic_status)) +
  labs(title = "Suicide vs eating problems by family economic status interaction",
       x = "Eating problems",
       y = "Suicide")

```

```{r message=FALSE, warning=FALSE}
ggplot(df, aes(x = sleeping_disturbance, y = suicide, color = major)) +
  geom_point() +
  geom_smooth(method="lm", se = FALSE, aes(group = major)) +
  labs(title = "Suicide vs sleeping disturbance by major interaction",
       x = "Sleeping disturbance",
       y = "Suicide")
```

```{r message=FALSE, warning=FALSE}
ggplot(df, aes(x = hostile_aggression, y = suicide, color = birth_place)) +
  geom_point() +
  geom_smooth(method="lm", se = FALSE, aes(group = birth_place)) +
  labs(title = "Suicide vs hostile_aggression by birth_place interaction",
       x = "Birth place",
       y = "Suicide")
```

```{r}
df$suicide <- factor_suicide
```

For these data, it seems that just the interaction between *eating problems and family economic status* and *sleeping disturbance and major* is relevant.

# Models developement
```{r}
idx <- sample(nrow(df), 0.80*nrow(df))
df_train <- df[idx,]
df_test <- df[-idx,]

# Training split dimension
dim(df_train)
# Testing split dimension
dim(df_test)
```

```{r}
mod_full <- glm(suicide ~ ., data=df_train, family="binomial")
summary(mod_full)
```

## Manual selection
```{r}
mod_manual <- glm(suicide ~ family_economic_status + psychiatric_symptoms +impulsivity +self_injury_behaviors, data=df_train, family="binomial")
summary(mod_manual)

```


## Category aggregation

## Stepwise regression
```{r}
mod_zero <- glm(suicide ~ 1, data=df_train, family="binomial")
mod_step <- stepAIC(mod_zero, direction = "both", scope = list(upper = formula(mod_full)), trace=0)
summary(mod_step)
```


## Lasso
```{r}
mod_lasso <- cv.glmnet(suicide ~ ., data = df_train, family = "binomial", alpha = 1)
coef_lasso <- coef(mod_lasso, s=mod_lasso$lambda.1se)[,1]
coeff_lasso_idx <- which(coef_lasso != 0)
print(cbind(coeff_lasso_idx, coef_lasso[coeff_lasso_idx])[,2])

plot(mod_lasso$glmnet.fit, xvar="lambda")
abline(v = log(mod_lasso$lambda.1se), lty = "dashed")

plot(mod_lasso)
abline(v = log(mod_lasso$lambda.1se), lty = "dashed")
```

## LDA
```{r}
mod_lda <- lda(suicide~., data=df_train)
```


## QDA
```{r}
mod_qda <- qda(suicide~., data=df_train)
```

## Naive Bayes
```{r}
mod_nb <- naiveBayes(suicide~., data = df_train)
```


## KNN
```{r}
x.train <- model.matrix(~ ., data=subset(df_train, select = -suicide))[, -1]
x.test <- model.matrix(~ ., data=subset(df_test, select = -suicide))[, -1]

k_max <- 3
rates <- double(k_max)
for (i in 1:k_max) {
  tmp <- knn(train = x.train, test = x.test, cl = df_train$suicide, k = i)
  rates[i] <- mean(tmp == df_test$suicide)
}
plot(x = (1:k_max), y = rates, xlab = "k", ylab = "Accuracy", type = "l")

best_k <- which.max(rates)
```

## Random Forest
```{r}
mod_rf <- randomForest(suicide ~ ., data=df_train, importance=TRUE, ntree=5)
print(mod_rf)

plot(mod_rf)
varImpPlot(mod_rf)
```


## Different model definition
```{r}
# FOR LATER
df$scaled_suicide <- scaled_suicide
df_train <- subset(df, select=-suicide)[idx,]
df_test <- subset(df, select=-suicide)[-idx,]
mod_test <- glm(cbind(scaled_suicide, (max(scaled_suicide) - scaled_suicide)) ~
             .,
           family = "binomial",
           data = df_train)
table(
 preds = predict(mod_test, newdata = df_test, type = "response"),
 true = df_test$scaled_suicide
)
df$scaled_suicide <- NULL
df_train <- df[idx,]
df_test <- df[-idx,]
```

# Model comparison
```{r}
probs_stepwise <- predict(mod_step, newdata = df_test, type = "response")
roc_stepwise <- roc(df_test$suicide ~ probs_stepwise, plot = TRUE, print.auc = TRUE)
coords_stepwise <- coords(roc_stepwise, x = "best", ret = c("threshold", "specificity", "sensitivity", "accuracy","tn","tp","fn","fp"))
print(coords_stepwise)
```

```{r}
probs_lasso <- predict(mod_lasso, newdata = df_test, s = mod_lasso$lambda.1se, type = "response")
roc_lasso <- roc(df_test$suicide ~ as.vector(probs_lasso), plot = TRUE, print.auc = TRUE)
coords_lasso <- coords(roc_lasso, x = "best", ret = c("threshold", "specificity", "sensitivity", "accuracy","tn","tp","fn","fp"))
print(coords_lasso)
```

```{r}
probs_lda <- predict(mod_lda, newdata = df_test, )
roc_lda <- roc(df_test$suicide ~ probs_lda$posterior[, 2], plot = TRUE, print.auc = TRUE)
coords_lda <- coords(roc_lda, x = "best", ret = c("threshold", "specificity", "sensitivity", "accuracy","tn","tp","fn","fp"))
print(coords_lda)
```

```{r}
probs_qda <- predict(mod_qda, newdata = df_test, )
roc_qda <- roc(df_test$suicide ~ probs_qda$posterior[, 2], plot = TRUE, print.auc = TRUE)
coords_qda <- coords(roc_qda, x = "best", ret = c("threshold", "specificity", "sensitivity", "accuracy","tn","tp","fn","fp"))
print(coords_qda)
```

```{r}
probs_nb <- predict(mod_nb, newdata = df_test, type = "raw")
roc_nb <- roc(df_test$suicide ~ probs_nb[, 2], plot = TRUE, print.auc = TRUE)
coords_nb <- coords(roc_nb, x = "best", ret = c("threshold", "specificity", "sensitivity", "accuracy","tn","tp","fn","fp"))
print(coords_nb)
```

```{r}
probs_knn <- knn(train = x.train, test = x.test, cl = df_train$suicide, k = best_k)
conf_matrix_knn <- table(df_test$suicide, probs_knn)
# Calculate True Positives (TP), True Negatives (TN), False Positives (FP), False Negatives (FN)
TP_knn <- conf_matrix_knn[2, 2]  # True Positives
TN_knn <- conf_matrix_knn[1, 1]  # True Negatives
FP_knn <- conf_matrix_knn[1, 2]  # False Positives
FN_knn <- conf_matrix_knn[2, 1]  # False Negatives

# Specificity (True Negative Rate)
specificity <- TN_knn / (TN_knn + FP_knn)
# Sensitivity (Recall or True Positive Rate)
sensitivity <- TP_knn / (TP_knn + FN_knn)
# Accuracy
accuracy <- (TP_knn + TN_knn) / sum(conf_matrix_knn)
coords_knn <- data.frame(threshold = NA, specificity = specificity, sensitivity = sensitivity, accuracy = accuracy, tn = TN_knn, tp = TP_knn, fn = FN_knn, fp = FP_knn)
```


```{r}
# allEffects((glm(suicide ~ gender +family_economic_status, data=df, family="binomial")))

# residualPlots(mod_zero)
# qqPlot(residuals(mod_full))
# influenceIndexPlot(mod_full, vars=c("Cook"))
# vif(model)


# plot(allEffects(mod3), ylab = "Probability of Survival", rescale.axis = FALSE)
# mod_zero <- glm(suicide ~ 1, data=df, family="binomial")
```

